# Research & Design Decisions

**Feature**: Whiteboard PUBLIC_SHARE Privilege
**Phase**: 0 (Research)
**Date**: 2025-11-06

## Overview

This document resolves technical unknowns and documents design decisions made during the planning phase. All clarifications from spec.md Session 2025-11-05 have been incorporated.

---

## Decision 1: Privilege Check Implementation Pattern

**Context**: Need to check if user has `PUBLIC_SHARE` privilege in `authorization.myPrivileges` array and conditionally render Guest access toggle.

**Decision**: Use type-safe array includes check with generated `AuthorizationPrivilege` enum.

**Rationale**:

- Existing `authorization.myPrivileges` field already available in whiteboard GraphQL queries
- TypeScript enum provides compile-time type safety and IDE autocomplete
- Simple array check (`myPrivileges.includes(AuthorizationPrivilege.PUBLIC_SHARE)`) is performant (<10ms)
- No additional GraphQL queries needed—data already in Apollo cache

**Alternatives Considered**:

1. ❌ **Add separate `canEnablePublicSharing` boolean field**: Rejected—adds unnecessary schema complexity when privilege system already exists
2. ❌ **Client-side authorization logic**: Rejected—violates Constitution (authorization must be backend-calculated)
3. ❌ **String literal check** (`myPrivileges.includes('PUBLIC_SHARE')`): Rejected—no type safety, prone to typos

**Implementation**:

```typescript
const hasPublicSharePrivilege = whiteboard.authorization.myPrivileges.includes(
  AuthorizationPrivilege.PUBLIC_SHARE
);

return hasPublicSharePrivilege ? <GuestAccessToggle /> : null;
```

---

## Decision 2: Error Handling Strategy

**Context**: GraphQL query for whiteboard authorization may fail (timeout, network error, malformed response).

**Decision**: Hide guest controls silently on error (no error message, no loading state).

**Rationale**:

- Prevents unauthorized users from seeing controls they can't use (security-first)
- Cleaner UX—users don't see transient error states for optional features
- Consistent with clarification decision (Session 2025-11-05)
- Aligns with "fail closed" security principle

**Alternatives Considered**:

1. ❌ **Show "Unable to determine permissions" message**: Rejected—creates noise for users who wouldn't have access anyway
2. ❌ **Show loading skeleton**: Rejected—clarification decision specified "no loading state"
3. ❌ **Retry logic**: Rejected—adds complexity without clear user benefit (Share dialog can be reopened)

**Implementation**:

```typescript
// If query errors or myPrivileges is undefined, hasPublicSharePrivilege = false
const hasPublicSharePrivilege =
  whiteboard?.authorization?.myPrivileges?.includes(AuthorizationPrivilege.PUBLIC_SHARE) ?? false;
```

---

## Decision 3: Cache Update Mechanism

**Context**: User privileges may change while Share dialog is open (admin toggles Space setting, privilege revoked).

**Decision**: Refetch whiteboard query on Share dialog open + rely on Apollo cache updates.

**Rationale**:

- Refetch on dialog open ensures fresh authorization data without complex subscription setup
- Apollo cache updates automatically trigger React re-renders when `myPrivileges` changes
- Simpler than GraphQL subscriptions or polling (clarification decision)
- Adequate for this use case—privilege changes are infrequent

**Alternatives Considered**:

1. ❌ **GraphQL subscriptions**: Rejected—over-engineered for infrequent privilege changes, adds complexity
2. ❌ **Polling**: Rejected—inefficient, unnecessary network traffic
3. ❌ **No refetch**: Rejected—may show stale privileges if user opens dialog long after navigation

**Implementation**:

- Add `refetchQueries` or `refetch()` call when Share dialog opens
- Existing Apollo cache reactivity handles mid-session updates

---

## Decision 4: TypeScript Type Safety

**Context**: `myPrivileges` array needs TypeScript typing for type-safe privilege checks.

**Decision**: Use generated `AuthorizationPrivilege[]` enum type from GraphQL schema.

**Rationale**:

- Generated types match backend schema exactly (single source of truth)
- Enum provides autocomplete: `AuthorizationPrivilege.PUBLIC_SHARE`
- Prevents typos and runtime errors
- `pnpm run codegen` automatically updates types when backend adds `PUBLIC_SHARE` enum value

**Alternatives Considered**:

1. ❌ **`string[]` type**: Rejected—no type safety, allows any string
2. ❌ **Manual enum definition**: Rejected—duplicates backend schema, risks drift

**Implementation**:

```typescript
// Generated by pnpm run codegen
export enum AuthorizationPrivilege {
  READ = 'READ',
  UPDATE = 'UPDATE',
  DELETE = 'DELETE',
  // ... existing privileges
  PUBLIC_SHARE = 'PUBLIC_SHARE', // Backend adds this
}

// Component usage
const myPrivileges: AuthorizationPrivilege[] = whiteboard.authorization.myPrivileges;
```

---

## Decision 5: Loading State Behavior

**Context**: Need to handle case where `authorization.myPrivileges` data is missing or delayed.

**Decision**: No loading state—hide guest controls immediately.

**Rationale**:

- Clarification decision (Session 2025-11-05): "no loading state"
- Simpler implementation—no skeleton UI to design/maintain
- Better UX—no flashing/flickering of controls
- Safe default—prevents showing unauthorized controls during loading

**Alternatives Considered**:

1. ❌ **Skeleton shimmer**: Rejected—clarification decision specified "no loading state"
2. ❌ **Spinner**: Rejected—same rationale as skeleton

**Implementation**:

```typescript
// If data is loading/missing, default to false (hide controls)
if (!whiteboard?.authorization?.myPrivileges) {
  return null; // No loading state shown
}
```

---

## Backend Coordination Requirements

**This feature depends on backend implementing**:

1. Add `PUBLIC_SHARE` value to `AuthorizationPrivilege` enum (GraphQL schema)
2. Include `PUBLIC_SHARE` in `authorization.myPrivileges` array for:
   - Space admins when `allowGuestContributions=true`
   - Whiteboard owners when `allowGuestContributions=true`
3. Exclude `PUBLIC_SHARE` when `allowGuestContributions=false` (space-level precedence)
4. Handle privilege lifecycle when Space setting changes
5. Maintain space-level independence (no inheritance between parent/subspace)

**Frontend blocks until**: Backend adds `PUBLIC_SHARE` to enum (step 1).

---

## Open Questions Resolved

All open questions from spec.md have been resolved via clarification session (2025-11-05):

1. ✅ **Privilege naming**: `PUBLIC_SHARE` (concise, consistent)
2. ✅ **Error handling**: Hide controls silently (safe default)
3. ✅ **Cache updates**: Refetch on dialog open + Apollo cache reactivity
4. ✅ **TypeScript types**: `AuthorizationPrivilege[]` (type-safe)
5. ✅ **Loading state**: No loading state (hide immediately)

---

## Best Practices Applied

1. **Type Safety**: Using generated GraphQL enums prevents runtime errors
2. **Separation of Concerns**: Authorization logic in backend, UI checks result
3. **Performance**: Simple array check (<10ms overhead)
4. **Security**: Fail closed (hide controls on error/missing data)
5. **Maintainability**: Minimal code changes, reuses existing patterns
6. **Accessibility**: No changes needed—existing controls already compliant

---

## Summary

All technical decisions resolved. No additional research needed. Ready to proceed to Phase 1 (Data Model & Contracts).
